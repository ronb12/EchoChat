rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the resource
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    // Users collection
    match /users/{userId} {
      // Allow users to read/write their own data
      allow read, write: if isOwner(userId);
      // Allow authenticated users to read public profiles
      allow read: if isAuthenticated() && 
        (resource.data.privacy == null || 
         resource.data.privacy.profileVisibility == 'public');
      // Allow authenticated users to read basic user info for presence/contacts
      allow read: if isAuthenticated();
    }
    
    // Profiles collection - for user profiles, aliases, status, etc.
    match /profiles/{userId} {
      // Allow authenticated users to read any profile (for displaying user info)
      allow read: if isAuthenticated();
      // Allow users to create their own profile
      allow create: if isAuthenticated() && isOwner(userId);
      // Allow users to update their own profile
      allow update: if isAuthenticated() && isOwner(userId);
      // Allow users to delete their own profile
      allow delete: if isAuthenticated() && isOwner(userId);
    }
    
    // Contacts collection - user's contact list
    match /contacts/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Chats collection
    match /chats/{chatId} {
      // Allow authenticated users to read chats they participate in
      allow read: if isAuthenticated() && 
        (resource.data.participants == null || request.auth.uid in resource.data.participants);
      // Allow creating chats if user is in participants list
      allow create: if isAuthenticated() && 
        request.resource.data.participants != null &&
        request.auth.uid in request.resource.data.participants;
      // Allow updating chats if user is a participant
      allow update: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
      // Allow deleting chats if user is a participant
      allow delete: if isAuthenticated() && 
        request.auth.uid in resource.data.participants;
    }
    
    // Messages collection
    match /messages/{messageId} {
      // Allow read if user is authenticated (for public messages or participants)
      allow read: if isAuthenticated();
      // Allow create if user is authenticated
      allow create: if isAuthenticated() && 
        request.resource.data.senderId == request.auth.uid;
      // Allow update/delete if user is the sender
      allow update, delete: if isAuthenticated() && 
        resource.data.senderId == request.auth.uid;
    }
    
    // Groups collection
    match /groups/{groupId} {
      allow read, write: if isAuthenticated() && 
        request.auth.uid in resource.data.members;
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.members;
    }
    
    // Notifications collection
    match /notifications/{notificationId} {
      allow read, write: if isAuthenticated() && 
        request.auth.uid == resource.data.userId;
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.userId;
    }
    
    // Settings collection
    match /settings/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Blocked users collection
    match /blocked/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Reports collection
    match /reports/{reportId} {
      allow create: if isAuthenticated();
      allow read: if isAuthenticated() && 
        request.auth.token.admin == true;
    }
    
    // Payments/Transactions collection (for Stripe)
    match /payments/{paymentId} {
      allow read: if isAuthenticated() && 
        (request.auth.uid == resource.data.senderId || 
         request.auth.uid == resource.data.recipientId);
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.senderId;
    }
    
    // Stripe accounts collection
    match /stripe_accounts/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Sticker packs collection
    match /stickerPacks/{packId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && 
        request.auth.token.admin == true;
    }
    
    // Sticker usage collection (for analytics)
    match /stickerUsage/{usageId} {
      allow read, write: if isAuthenticated();
    }
    
    // FCM tokens collection (for push notifications)
    match /fcmTokens/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Polls collection
    match /polls/{pollId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        request.resource.data.createdBy == request.auth.uid;
      allow update, delete: if isAuthenticated() && 
        resource.data.createdBy == request.auth.uid;
    }
    
    // Businesses collection
    match /businesses/{businessId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && 
        (resource == null || resource.data.ownerId == request.auth.uid);
    }
    
    // Organizations collection (enterprise)
    match /organizations/{orgId} {
      allow read: if isAuthenticated() && 
        request.auth.uid in resource.data.members;
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.members;
      allow update, delete: if isAuthenticated() && 
        request.auth.uid == resource.data.ownerId;
    }
    
    // Audit logs collection (enterprise)
    match /auditLogs/{logId} {
      allow read: if isAuthenticated() && 
        request.auth.token.admin == true;
      allow create: if isAuthenticated();
    }
    
    // Communities collection
    match /communities/{communityId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() && 
        request.auth.uid == request.resource.data.creatorId;
      allow update, delete: if isAuthenticated() && 
        request.auth.uid == resource.data.creatorId;
    }
    
    // Announcements collection
    match /announcements/{announcementId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && 
        (resource == null || resource.data.createdBy == request.auth.uid);
    }
    
    // Workspaces collection (collaboration)
    match /workspaces/{workspaceId} {
      allow read: if isAuthenticated() && 
        request.auth.uid in resource.data.members;
      allow create: if isAuthenticated() && 
        request.auth.uid in request.resource.data.members;
      allow update, delete: if isAuthenticated() && 
        request.auth.uid == resource.data.ownerId;
    }
    
    // Channels collection (collaboration)
    match /channels/{channelId} {
      allow read: if isAuthenticated() && 
        request.auth.uid in get(/databases/$(database)/documents/workspaces/$(resource.data.workspaceId)).data.members;
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() && 
        request.auth.uid == resource.data.createdBy;
    }
    
    // Tasks collection (collaboration)
    match /tasks/{taskId} {
      allow read: if isAuthenticated();
      allow create, update, delete: if isAuthenticated() && 
        (resource == null || resource.data.createdBy == request.auth.uid);
    }
    
    // Two-factor authentication codes
    match /twoFactorCodes/{userId} {
      allow read, write: if isOwner(userId);
    }
    
    // Typing indicators subcollection under chats
    match /chats/{chatId}/typing/{userId} {
      allow read: if isAuthenticated() && 
        request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants;
      allow write: if isAuthenticated() && 
        (request.auth.uid == userId || 
         request.auth.uid in get(/databases/$(database)/documents/chats/$(chatId)).data.participants);
    }
  }
}
